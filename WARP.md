# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Project Overview

This is an all-in-one solution to deploy GLPI (IT Asset Management system) on AWS using Terraform for infrastructure provisioning and Ansible for configuration management. The project uses Terramate for stack management and supports multiple environments (dev, staging, prod).

## Architecture

The infrastructure deploys a complete AWS environment with:

- **VPC**: Main VPC (10.0.0.0/16) with multiple subnets across availability zones
- **Bastion Host**: Public subnet with internet access for SSH jumphost functionality  
- **GLPI Application**: EC2 instance in private subnet with EBS volumes for data/config/logs
- **RDS Database**: MySQL 8.0 in private subnet with multi-AZ support (configurable)
- **Application Load Balancer**: Public-facing ALB with HTTPS redirect and self-signed certificates
- **NAT Gateway**: Enables outbound internet access for private subnet resources

The system uses a layered security model with separate security groups for each component and SSH access through bastion host only.

## Environment Management

The project supports multiple environments through tfvars files:
- `envs/dev.tfvars` - Development environment (single instance, smaller volumes)
- `envs/staging.tfvars` - Staging environment  
- `envs/prod.tfvars` - Production environment (larger volumes, multi-AZ RDS)

Set the environment using: `export AWS_INFRA_PLATFORM=dev|staging|prod` (defaults to dev)

## Development Commands

### Infrastructure Management
```bash
# Plan infrastructure changes
./jobs/plan

# Deploy infrastructure
./jobs/deploy

# Destroy infrastructure  
./jobs/destroy
```

### Application Deployment
```bash
# Install Ansible requirements
./jobs/requirements

# Deploy GLPI application (after infrastructure is ready)
./jobs/install

# Run tests
./jobs/test
```

### Environment Setup
```bash
# Set environment (dev/staging/prod)
export AWS_INFRA_PLATFORM=dev

# Initialize Terraform backend (one-time setup)
cd backend && terraform init && terraform apply
```

## File Structure

- **Terraform Files**: Infrastructure as code split by component (vpc.tf, glpi.tf, db.tf, etc.)
- **jobs/**: Executable scripts for common operations with environment variable setup
- **playbooks/**: Ansible playbooks for system initialization and GLPI deployment
- **inventory/**: Ansible inventory configuration (auto-generated by Terraform)
- **envs/**: Environment-specific variable files
- **.config/**: Cloud-init scripts for instance initialization

## Key Dependencies

- **Terraform** >= 1.0 with AWS provider >= 5.0
- **Ansible** with `rafikbahri.glpi` role v0.4.3
- **Terramate** for stack management
- **AWS CLI** configured with appropriate credentials

## SSH Configuration

The project uses SSH key forwarding through bastion host. SSH config is auto-generated to `.ssh/config` by Terraform inventory output.

## Important Notes

- Database passwords are stored in tfvars files (should be moved to secrets manager for production)
- Self-signed certificates are used for HTTPS (replace with proper certificates for production)
- The setup includes hardcoded SSH public keys in user_data scripts that should be parameterized
- Terraform state is stored in S3 with DynamoDB locking (backend must be created first)

## Terramate Integration

This is a Terramate stack with organization "rafik-bahri". Use Terramate commands for advanced stack operations and cloud integration.
